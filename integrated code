#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <MQUnifiedsensor.h>

// OLED display settings
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
#define OLED_RESET -1
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);

// MQ Sensors
#define Board "ESP32"
#define Voltage_Resolution 3.3
#define ADC_Bit_Resolution 12
#define RatioMQ2CleanAir 9.83
#define RatioMQ7CleanAir 27.5
#define RatioMQ135CleanAir 3.6
#define pinMQ2 34
#define pinMQ7 35
#define pinMQ135 32

MQUnifiedsensor MQ2(Board, Voltage_Resolution, ADC_Bit_Resolution, pinMQ2, "MQ-2");
MQUnifiedsensor MQ7(Board, Voltage_Resolution, ADC_Bit_Resolution, pinMQ7, "MQ-7");
MQUnifiedsensor MQ135(Board, Voltage_Resolution, ADC_Bit_Resolution, pinMQ135, "MQ-135");

// GP2Y1010AU0F (Dust Sensor) configuration
#define GP2Y_LED 26
#define GP2Y_AOUT 33

void setup() {
    Serial.begin(115200);
    Wire.begin();
    display.begin(SSD1306_SWITCHCAPVCC, 0x3C);
    display.clearDisplay();
    display.setTextSize(1);
    display.setTextColor(WHITE);
    
    // MQ Sensors Initialization
    MQ2.setRegressionMethod(1);
    MQ2.init();
    MQ7.setRegressionMethod(1);
    MQ7.init();
    MQ135.setRegressionMethod(1);
    MQ135.init();

    Serial.println("Sensors Initialized...");
}

void loop() {
    float mq2_val = MQ2.readSensor();   // LPG, Smoke
    float mq7_val = MQ7.readSensor();   // CO
    float mq135_val = MQ135.readSensor(); // Air Quality
    
    // Dust Sensor Reading
    int dustVal = analogRead(GP2Y_AOUT);
    float dustDensity = (dustVal / 1024.0) * 5.0 * 0.17; // Convert to mg/m3
    
    Serial.print("MQ-2: "); Serial.print(mq2_val);
    Serial.print(" MQ-7: "); Serial.print(mq7_val);
    Serial.print(" MQ-135: "); Serial.print(mq135_val);
    Serial.print(" Dust: "); Serial.println(dustDensity);
    
    // Display on OLED
    display.clearDisplay();
    display.setCursor(0, 0);
    display.print("Air Quality Monitor");
    display.setCursor(0, 10);
    display.print("MQ-2: "); display.print(mq2_val); display.println(" ppm");
    display.print("MQ-7: "); display.print(mq7_val); display.println(" ppm");
    display.print("MQ-135: "); display.print(mq135_val); display.println(" ppm");
    display.print("Dust: "); display.print(dustDensity); display.println(" mg/m3");
    
    // Suggestions based on readings
    display.setCursor(0, 45);
    if (mq135_val > 200 || dustDensity > 0.1) {
        display.print("Ventilate Room");
    } else if (mq7_val > 50) {
        display.print("Avoid Traffic Areas");
    } else if (mq2_val > 100) {
        display.print("Check Gas Leakage");
    } else {
        display.print("Air Quality Good");
    }
    
    display.display();
    delay(2000);
}
